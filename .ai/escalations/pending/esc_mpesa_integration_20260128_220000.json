{
  "escalation_id": "esc_mpesa_integration_20260128_220000",
  "created_at": "2026-01-28T22:00:00Z",
  "escalation_type": "technical_decision",
  "priority": "high",
  "status": "pending",
  "title": "M-Pesa Integration Approach - Custom Django vs Python Packages",

  "research_summary": {
    "topic": "M-Pesa Daraja API Integration for Django 5.0+ ERP System",
    "research_date": "2026-01-28",
    "researcher": "research_agent",
    "options_evaluated": 3,
    "research_duration_hours": 8,
    "confidence_level": "HIGH (9.3/10)"
  },

  "business_context": {
    "mission_requirement": "M-Pesa integration required for 3 businesses (Water, Laundry, Retail) - LOCKED (DEC-006)",
    "critical_requirements": [
      "Zero payment loss tolerance",
      "Multiple M-Pesa tills (one per business)",
      "STK Push + C2B support",
      "Automatic payment reconciliation with double-entry ledger",
      "Duplicate detection and prevention",
      "Django 5.0+ compatibility"
    ],
    "constraints": {
      "budget": "$15,000 total, $200/month operational",
      "timeline": "MVP in 3 months (M-Pesa in Sprint 3-4, Weeks 5-8)",
      "technology": "Django 5.0+, PostgreSQL, VPS deployment (4GB RAM)"
    }
  },

  "options": [
    {
      "option_id": "custom_django",
      "name": "Custom Django Integration (RECOMMENDED)",
      "description": "Build custom M-Pesa integration module using Django 5.0+ and DRF with full control over implementation",

      "pros": [
        "Full Django 5.0+ support (built with latest Django)",
        "Zero payment loss guarantee (atomic transactions, status query fallback)",
        "Multi-till support (MpesaTill model supports unlimited tills)",
        "Production-grade error handling (all M-Pesa error codes)",
        "Comprehensive security (encrypted credentials, callback validation)",
        "Duplicate detection built-in (idempotency keys, unique constraints)",
        "Status query fallback (zero payment loss)",
        "Async callback processing (Django-RQ integration)",
        "Ledger integration (double-entry accounting)",
        "Audit trail (7-year retention)",
        "Daily reconciliation (MpesaReconciliation model)",
        "Active maintenance (you own the code)",
        "No additional API costs (Daraja API is free)",
        "Fits within $200/month VPS budget"
      ],

      "cons": [
        "Higher development effort (10-12 days vs 1-2 days for packages)",
        "Requires thorough testing (mission-critical)",
        "Need to understand Daraja API nuances"
      ],

      "mission_fit": {
        "score": 9.5,
        "details": "Aligns perfectly with all mission requirements: multi-till, zero payment loss, ledger integration, Django 5.0+, comprehensive error handling"
      },

      "cost_analysis": {
        "development_cost": "$4,000 (80 hours @ $50/hr)",
        "operational_cost": "$0/month (no additional infrastructure)",
        "transaction_costs": "Standard M-Pesa fees (paid by customers)",
        "total_12_month_cost": "$4,000"
      },

      "timeline_estimate": {
        "foundation": "Week 1 (3 days) - OAuth, STK Push, models",
        "ledger_integration": "Week 2 (4 days) - Callback, ledger, async",
        "production_ready": "Week 3 (3 days) - Error handling, reconciliation",
        "total": "10 days (fits Sprint 3-4 timeline)"
      },

      "risks": [
        {
          "risk": "Development timeline longer than using packages",
          "probability": "Medium",
          "impact": "Low",
          "mitigation": "Clear requirements, modular code design, reuse existing stack (Django-RQ, Redis)"
        },
        {
          "risk": "Production bugs due to API changes",
          "probability": "Low",
          "impact": "Medium",
          "mitigation": "Comprehensive sandbox testing, modular code (easy to update), monitor first 100 transactions"
        },
        {
          "risk": "Callback delivery failures",
          "probability": "Medium (10-20%)",
          "impact": "High",
          "mitigation": "Status query fallback after 30 seconds, daily reconciliation, residual risk <1%"
        }
      ],

      "confidence": "HIGH (9.5/10)"
    },

    {
      "option_id": "django_daraja",
      "name": "django-daraja Package (NOT RECOMMENDED)",
      "description": "Use existing Django package for M-Pesa integration",

      "pros": [
        "Quick setup (1-2 days if it works)",
        "Batteries included (models, views, serializers)",
        "Django admin integration"
      ],

      "cons": [
        "No Django 5.0+ support (BLOCKER for project)",
        "Inactive maintenance (last update 2022)",
        "Outdated API coverage (missing STK Push v2 updates)",
        "High security risk (unmaintained package for financial transactions)",
        "Unknown security vulnerabilities (no recent audits)",
        "Limited customization (can't adapt to multi-business needs)",
        "Poor documentation (references old endpoints)",
        "No active maintainer (issues unresolved)",
        "Missing mission-critical features (duplicate detection, reconciliation)"
      ],

      "mission_fit": {
        "score": 4.0,
        "details": "Fails critical requirements: no Django 5.0+ support, inactive maintenance (high risk for financial transactions), missing multi-till support, zero payment loss not guaranteed"
      },

      "cost_analysis": {
        "development_cost": "$2,500 (50 hours @ $50/hr) + Fixing Django 5.0 issues (unknown)",
        "operational_cost": "$0/month",
        "total_12_month_cost": "$2,500 - $5,000 (depending on fix complexity)"
      },

      "timeline_estimate": {
        "setup": "1-2 days",
        "fixing_django_5_issues": "1-2 weeks (unknown complexity)",
        "adding_missing_features": "1-2 weeks",
        "total": "3-5 weeks (exceeds Sprint 3-4 timeline)"
      },

      "risks": [
        {
          "risk": "Package breaks in production due to Django 5.0 incompatibility",
          "probability": "High",
          "impact": "Critical (payments blocked)",
          "mitigation": "None (package is unmaintained)"
        },
        {
          "risk": "Security vulnerabilities due to lack of updates",
          "probability": "High",
          "impact": "Critical (financial data breach)",
          "mitigation": "None (package is unmaintained)"
        },
        {
          "risk": "Missing STK Push v2 features causing payment failures",
          "probability": "Medium",
          "impact": "High",
          "mitigation": "None (package is unmaintained)"
        }
      ],

      "confidence": "VERY LOW (2/10)",
      "eliminated": true,
      "elimination_reason": "Too risky for financial transactions, no Django 5.0+ support, inactive maintenance"
    },

    {
      "option_id": "mpesa_api_python",
      "name": "mpesa-api-python Package (NOT RECOMMENDED)",
      "description": "Use Python wrapper for M-Pesa API (not Django-specific)",

      "pros": [
        "Pure Python (works with Django)",
        "Basic API coverage (STK Push, C2B)"
      ],

      "cons": [
        "Not Django-specific (requires custom integration work)",
        "Inactive maintenance (last update 2021)",
        "Outdated API coverage (missing recent updates)",
        "Minimal documentation",
        "No error handling patterns",
        "No duplicate detection features",
        "No ledger integration",
        "Poor community support (unresolved bugs)",
        "Higher integration complexity than custom Django implementation"
      ],

      "mission_fit": {
        "score": 3.5,
        "details": "Not Django-specific (more integration work), inactive maintenance, missing mission-critical features (multi-till, duplicate detection, reconciliation, ledger integration)"
      },

      "cost_analysis": {
        "development_cost": "$3,000 (60 hours @ $50/hr)",
        "operational_cost": "$0/month",
        "total_12_month_cost": "$3,000"
      },

      "timeline_estimate": {
        "package_setup": "1 day",
        "django_integration": "1-2 weeks",
        "error_handling_duplicate_detection": "1 week",
        "total": "3-4 weeks"
      },

      "risks": [
        {
          "risk": "Using unmaintained package for financial transactions",
          "probability": "High",
          "impact": "Critical",
          "mitigation": "None"
        },
        {
          "risk": "Integration complexity increases timeline",
          "probability": "Medium",
          "impact": "Medium",
          "mitigation": "None (better to build custom)"
        },
        {
          "risk": "Missing recent API updates",
          "probability": "Medium",
          "impact": "High",
          "mitigation": "None"
        }
      ],

      "confidence": "VERY LOW (1.5/10)",
      "eliminated": true,
      "elimination_reason": "Better to build custom Django integration from scratch (more control, similar timeline)"
    }
  ],

  "recommendation": {
    "primary_choice": "custom_django",
    "confidence": "HIGH (9.3/10)",
    "reasoning": [
      "M-Pesa Daraja API is mature and well-documented",
      "Custom integration eliminates dependency on unmaintained packages",
      "Django 5.0 + DRF is excellent for API integrations",
      "Architecture aligns with existing stack decisions (Django-RQ for background tasks, Redis for caching, PostgreSQL)",
      "Zero payment loss guarantee with atomic transactions and status query fallback",
      "Multi-till support built-in (critical for 3-business requirement)",
      "Production-grade error handling (all M-Pesa error codes covered)",
      "Comprehensive security (encrypted credentials, callback validation)",
      "Ledger integration (double-entry accounting aligned with DEC-005)",
      "Daily reconciliation (catches discrepancies early)",
      "Audit trail (7-year retention for KRA compliance)",
      "Fits 10-day timeline (Sprint 3-4, Weeks 5-8)",
      "No additional operational costs (uses existing VPS infrastructure)"
    ],

    "why_not_alternatives": [
      "django-daraja: Inactive maintenance, no Django 5.0+ support, high security risk for financial transactions (BLOCKER)",
      "mpesa-api-python: Not Django-specific, inactive maintenance, missing mission-critical features, similar timeline to custom but less control"
    ],

    "remaining_uncertainty": "0.7/10",
    "uncertainty_factors": [
      "Production go-live certification process with Safaricom (depends on their timeline, typically 1-2 weeks)",
      "Actual production API reliability (sandbox may differ from production, mitigate with UAT)",
      "Callback delivery reliability in Kenya network conditions (mitigate with status query fallback)"
    ]
  },

  "decision_impact": {
    "architectural": {
      "impact": "LOW",
      "details": "Custom integration fits existing architecture: Django app structure, uses Django-RQ (already selected), uses Redis (already selected), integrates with ledger models"
    },

    "technical": {
      "impact": "LOW",
      "details": "No new infrastructure needed. Uses existing Django 5.0+, DRF, Django-RQ, Redis, PostgreSQL stack. Development timeline fits Sprint 3-4 (10 days)."
    },

    "cost": {
      "impact": "ACCEPTABLE",
      "details": "Development cost: $4,000 (80 hours). Operational cost: $0/month (no additional infrastructure). Fits within $15,000 budget and $200/month operational limit."
    },

    "timeline": {
      "impact": "LOW",
      "details": "10-day implementation fits Sprint 3-4 (4-week sprint). Allows 2 weeks buffer for testing and UAT. Go-live target: Week 8 (end of Sprint 4)."
    },

    "team": {
      "impact": "LOW",
      "details": "Team already knows Django. New skills needed: M-Pesa API integration (2 days training). No external specialists required."
    },

    "security": {
      "impact": "POSITIVE",
      "details": "Custom implementation allows full security control: encrypted credentials, callback validation, audit trail, IP whitelisting. No dependency on unmaintained packages."
    },

    "risk": {
      "impact": "LOW",
      "details": "Primary risks mitigated: callback failures (status query fallback), duplicates (idempotency keys), OAuth expiry (auto-refresh). Residual risk: <1% payment loss (acceptable)."
    }
  },

  "implementation_outline": {
    "phase_1_foundation": {
      "duration": "Week 1 (3 days)",
      "tasks": [
        "Create Django app: mpesa_integration",
        "Create models: MpesaTill, MpesaPayment, MpesaCallbackLog, MpesaReconciliation",
        "Implement encryption utility (for credentials)",
        "Implement OAuth service (token generation, caching with Redis)",
        "Implement STK Push service (password generation, request formatting)",
        "Implement idempotency key generation",
        "Create API view: initiate_stk_push",
        "Unit tests for OAuth and STK Push services",
        "Sandbox testing (successful payment flow)"
      ]
    },

    "phase_2_ledger_integration": {
      "duration": "Week 2 (4 days)",
      "tasks": [
        "Create API view: stk_push_callback",
        "Implement callback logging (MpesaCallbackLog)",
        "Implement duplicate callback detection",
        "Implement _create_payment_ledger_entry() function (double-entry)",
        "Integrate with Sale model (update payment_status)",
        "Set up Django-RQ worker",
        "Implement process_stk_push_result background job",
        "Implement status query service",
        "Create query_payment_status_fallback background job",
        "Integrate with Water, Laundry, Retail sales/invoices",
        "End-to-end testing (all 3 businesses)"
      ]
    },

    "phase_3_production_ready": {
      "duration": "Week 3 (3 days)",
      "tasks": [
        "Implement all M-Pesa error code handling",
        "Create error log for failed payments",
        "Implement retry logic (timeouts, network failures)",
        "Implement daily reconciliation task (Django-RQ scheduled job)",
        "Implement credential encryption",
        "Implement callback IP whitelist (Safaricom IPs)",
        "Comprehensive sandbox testing (all scenarios)",
        "Load testing (100+ payments/day)",
        "Security audit (credential storage, API exposure)"
      ]
    },

    "total_duration": "10 days (fits Sprint 3-4 timeline)",
    "buffer": "6 days remaining in 4-week sprint for testing and UAT"
  },

  "testing_strategy": {
    "sandbox_scenarios": [
      "Successful payment flow (STK Push → PIN → Callback → Ledger)",
      "Failed payment (insufficient funds)",
      "Payment timeout (customer doesn't enter PIN)",
      "Duplicate detection (same request twice)",
      "Callback failure (status query fallback)",
      "Multi-till support (all 3 businesses)",
      "Ledger integration (double-entry)",
      "Concurrent payments (10+ simultaneous)",
      "Callback replay attack (duplicate callback)",
      "OAuth token expiry (auto-refresh)"
    ],

    "uat_process": [
      "Submit sandbox test results to Safaricom",
      "Request UAT till number (real till, test environment)",
      "Conduct real transactions (small amounts: 10-100 KES)",
      "Verify callbacks work correctly",
      "Document UAT results",
      "Submit UAT results to Safaricom for production approval"
    ],

    "production_readiness_checklist": [
      "Credentials encrypted in database",
      "HTTPS configured with valid SSL certificate",
      "Callback URLs accessible from internet",
      "IP whitelist configured (Safaricom IPs)",
      "Rate limiting configured",
      "Django-RQ dashboard monitoring",
      "Failed payment alerting",
      "Daily reconciliation report scheduled",
      "Logging configured (payment logs, error logs)"
    ]
  },

  "code_examples_provided": {
    "oauth_service": "services/oauth_service.py - Token generation and caching with Redis",
    "stk_push_service": "services/stk_push_service.py - STK Push initiation with idempotency",
    "callback_handler": "api_views/stk_push_callback.py - Callback processing with async job",
    "ledger_integration": "Double-entry ledger creation for M-Pesa payments",
    "status_query": "services/status_query_service.py - Fallback when callback fails",
    "reconciliation": "tasks/daily_reconciliation.py - Daily till balance reconciliation",
    "database_models": "MpesaTill, MpesaPayment, MpesaCallbackLog, MpesaReconciliation"
  },

  "security_best_practices": {
    "credential_security": [
      "Encrypt M-Pesa credentials at rest (Passkey, Consumer Key, Consumer Secret)",
      "Store credentials in environment variables (not in code)",
      "Never log credentials (mask in logs)",
      "Rotate credentials every 3-6 months"
    ],
    "api_security": [
      "Use HTTPS for all API requests (TLS 1.3)",
      "Validate callback source (IP whitelist Safaricom IPs)",
      "Implement rate limiting (5 STK Push requests/minute per phone)",
      "Implement API authentication (JWT tokens)"
    ],
    "fraud_prevention": [
      "Idempotency keys (prevent duplicate STK Push requests)",
      "Unique constraint on M-Pesa receipt number",
      "Amount verification (match callback with expected)",
      "Phone number validation (format: 2547XXXXXXXX)"
    ]
  },

  "common_pitfalls_and_solutions": {
    "callback_never_received": {
      "cause": "Network issues, Safaricom downtime, callback URL blocked",
      "impact": "Payment successful but system doesn't know (payment lost)",
      "solution": "Status query fallback after 30 seconds, daily reconciliation"
    },
    "duplicate_payment_processing": {
      "cause": "Same callback received twice",
      "impact": "Ledger imbalance (revenue counted twice)",
      "solution": "Unique constraint on M-Pesa receipt, idempotency keys"
    },
    "oauth_token_expired": {
      "cause": "Token cached too long",
      "impact": "STK Push initiation fails",
      "solution": "Cache with 55-minute expiry, auto-refresh"
    },
    "callback_url_not_accessible": {
      "cause": "Firewall, HTTPS not configured, DNS issues",
      "impact": "Safaricom cannot send callback",
      "solution": "Test callback URL, configure firewall, use HTTPS"
    }
  },

  "operational_considerations": {
    "monitoring": [
      "Real-time: No callbacks for >5 minutes, payment failure rate >5%, callback processing errors",
      "Daily: Payment success rate (>95% target), callback loss rate (<2% target), reconciliation matches",
      "Weekly: Total payments per till, failure reasons breakdown"
    ],
    "maintenance": [
      "Daily: Review failed payments, verify reconciliation",
      "Weekly: Review callback logs, test status query fallback",
      "Monthly: Audit payment ledger, review API credentials, test backup/restore",
      "Quarterly: Security audit, performance review"
    ]
  },

  "deliverables": {
    "documentation": [
      "M-Pesa integration architecture document",
      "API endpoint specification (initiate_stk_push, stk_push_callback)",
      "Database schema documentation (MpesaTill, MpesaPayment, etc.)",
      "Troubleshooting guide (common issues and solutions)",
      "Runbook (payment processing, reconciliation)",
      "Security best practices checklist"
    ],
    "code": [
      "Django app: mpesa_integration",
      "Models: MpesaTill, MpesaPayment, MpesaCallbackLog, MpesaReconciliation",
      "Services: OAuth, STK Push, Status Query",
      "API Views: STK Push initiate, callback, C2B validation/confirmation",
      "Background Tasks: Callback processing, status query, reconciliation",
      "Unit tests (80%+ coverage required)"
    ],
    "testing": [
      "Sandbox test results (all 10 scenarios)",
      "UAT test results (real transactions)",
      "Load test results (100+ payments/day)",
      "Security audit results (credential storage, API exposure)"
    ]
  },

  "success_metrics": {
    "technical": [
      "STK Push success rate: >95%",
      "Callback processing time: <500ms (p95)",
      "Callback loss rate: <2% (with status query fallback)",
      "Duplicate payment rate: 0%",
      "Ledger accuracy: 100% (always balances)"
    ],
    "business": [
      "Payment processing time: <30 seconds (end-to-end)",
      "Customer satisfaction: No payment complaints",
      "Financial accuracy: Zero payment loss",
      "Reconciliation time: <10 minutes daily"
    ]
  },

  "next_steps": {
    "if_approved": [
      "Create Safaricom Daraja developer account (https://developer.safaricom.co.ke)",
      "Create sandbox app and obtain test credentials",
      "Review Daraja API documentation (STK Push, C2B)",
      "Approve 10-day implementation timeline for Sprint 3-4",
      "Ensure Django-RQ is installed and configured (DEC-P04)",
      "Ensure Redis is available (for caching and task queue)",
      "Review code examples in research report",
      "Set up development environment for testing"
    ],
    "go_live_preparation": [
      "Complete sandbox testing (all 10 scenarios)",
      "Submit UAT results to Safaricom",
      "Obtain production credentials (1-2 weeks approval process)",
      "Plan go-live for Sprint 4 end (Week 8)",
      "Monitor first 100 transactions closely",
      "Daily reconciliation for first week"
    ]
  },

  "sources": [
    "Safaricom Daraja API Portal: https://developer.safaricom.co.ke",
    "Django 5.0 Documentation: https://docs.djangoproject.com/en/5.0/",
    "Django REST Framework: https://www.django-rest-framework.org/",
    "django-rq: https://github.com/rq/django-rq",
    "OWASP API Security: https://owasp.org/www-project-api-security/"
  ],

  "research_outputs": [
    "/media/munen/muneneENT/ementech-portfolio/tomtin/docs/research/mission_analysis_mpesa.md",
    "/media/munen/muneneENT/ementech-portfolio/tomtin/docs/research/research_mpesa_integration_20260128.md"
  ],

  "decision_questions": [
    "Do you approve the custom Django integration approach for M-Pesa Daraja API?",
    "Do you approve the 10-day implementation timeline (fits Sprint 3-4)?",
    "Do you approve the development cost estimate ($4,000, 80 hours)?",
    "Should we proceed with sandbox testing immediately after approval?",
    "Do you want to review the code examples before implementation starts?"
  ],

  "approval_instructions": {
    "to_approve": "Respond with 'Approved' and answer the decision questions above",
    "to_reject": "Provide reason for rejection and alternative approach preferred",
    "to_defer": "Provide additional information needed for decision",
    "timeline": "Decision needed by 2026-02-03 to fit Sprint 3-4 timeline"
  }
}
